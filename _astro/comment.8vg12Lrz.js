const y={"Content-Type":"application/json"},m=e=>`${e.replace(/\/?$/,"/")}api/`,d=(e,t="")=>{if(typeof e=="object"&&e.errno)throw new TypeError(`${t} failed with ${e.errno}: ${e.errmsg}`);return e},f=({serverURL:e,lang:t,paths:a,type:o,signal:n})=>fetch(`${m(e)}article?path=${encodeURIComponent(a.join(","))}&type=${encodeURIComponent(o.join(","))}&lang=${t}`,{signal:n}).then(r=>r.json()).then(r=>d(r,"Get counter").data),w=({serverURL:e,lang:t,path:a,type:o,action:n})=>fetch(`${m(e)}article?lang=${t}`,{method:"POST",headers:y,body:JSON.stringify({path:a,type:o,action:n})}).then(r=>r.json()).then(r=>d(r,"Update counter").data),U=({serverURL:e,lang:t,paths:a,signal:o})=>f({serverURL:e,lang:t,paths:a,type:["time"],signal:o}),R=e=>w({...e,type:"time",action:"inc"}),v=(e="")=>e.replace(/\/$/u,""),b=e=>/^(https?:)?\/\//.test(e),g=e=>{const t=v(e);return b(t)?t:`https://${t}`},L=e=>{e.name!=="AbortError"&&console.error(e.message)},u=e=>{const{path:t}=e.dataset;return t!=null&&t.length?t:null},$=(e,t)=>{t.forEach((a,o)=>{const n=e[o].time;typeof n=="number"&&(a.innerText=n.toString())})},G=({serverURL:e,path:t=window.location.pathname,selector:a=".waline-pageview-count",update:o=!0,lang:n=navigator.language})=>{const r=new AbortController,s=Array.from(document.querySelectorAll(a)),i=c=>{const l=u(c);return l!==null&&t!==l},p=c=>U({serverURL:g(e),paths:c.map(l=>u(l)??t),lang:n,signal:r.signal}).then(l=>$(l,c)).catch(L);if(o){const c=s.filter(h=>!i(h)),l=s.filter(i);R({serverURL:g(e),path:t,lang:n}).then(h=>$(h,c)),l.length&&p(l)}else p(s);return r.abort.bind(r)},j=e=>`${e.replace(/\/?$/,"/")}api/`,A=(e,t="")=>{if(typeof e=="object"&&e.errno)throw new TypeError(`${t} failed with ${e.errno}: ${e.errmsg}`);return e},S=({serverURL:e,lang:t,paths:a,signal:o})=>fetch(`${j(e)}comment?type=count&url=${encodeURIComponent(a.join(","))}&lang=${t}`,{signal:o}).then(n=>n.json()).then(n=>A(n,"Get comment count").data),C=e=>{try{e=decodeURI(e)}catch{}return e},E=(e="")=>e.replace(/\/$/u,""),T=e=>/^(https?:)?\/\//.test(e),I=e=>{const t=E(e);return T(t)?t:`https://${t}`},x=e=>{e.name!=="AbortError"&&console.error(e.message)},q=e=>{const{path:t}=e.dataset;return t!=null&&t.length?t:null},O=({serverURL:e,path:t=window.location.pathname,selector:a=".waline-comment-count",lang:o=navigator.language})=>{const n=new AbortController,r=document.querySelectorAll(a);return r.length&&S({serverURL:I(e),paths:Array.from(r).map(s=>C(q(s)??t)),lang:o,signal:n.signal}).then(s=>{r.forEach((i,p)=>{i.innerText=s[p].toString()})}).catch(x),n.abort.bind(n)};export{G as S,O as v};
